services:
  lgtm:
    image: grafana/otel-lgtm
    #container_name: halgtm
    hostname: lgtm
    ports:
      - 45580:3000
      - 45581:4317
      - 45582:4318
      - 45583:9090
    networks:
      - otelnet
    profiles: ["optional", "otel"] # docker compose --profile optional up
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  postgres:
    image: postgres:latest
    environment:
      POSTGRES_DB: testdb
      POSTGRES_USER: highbyte
      POSTGRES_PASSWORD: password
    ports:
      - 5532:5432
    volumes:
      - postgresVol:/var/lib/postgresql
#      - ./init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro  # Auto-creates tables on first run
    networks:
      - pgnet
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U highbyte -d testdb"]
      interval: 5s
      timeout: 5s
      retries: 10
    profiles: ["optional", "postgres"] # docker compose --profile optional up

  highbyteCentralNode:
    image: highbyte:${IMAGE_VERSION}
    #container_name: highbyteCentralNode
    hostname: highbyteCentralNode
    ports:
      - 45500:45245
      - 45501:8885
      - 45502:1885
      - 45503:9001
    volumes:
      - highbyteCentralNodeVol:/usr/local/highbyte/appData
      - ./central-node-deployment-settings.json:/usr/local/highbyte/deployments/deployment-settings.json:ro
      - ./central-node-deployment-config.json:/usr/local/highbyte/deployments/default-deployment-config.json:ro
    networks:
      - pgnet
      - otelnet
      - mqttnet
    environment:
      OTEL_RESOURCE_ATTRIBUTES: service.instance.id=CentralNode
      JDK_JAVA_OPTIONS: >-
        -javaagent:lib/opentelemetry-javaagent.jar
        -Dotel.exporter.otlp.endpoint=http://lgtm:4318
        -Dotel.service.name=HighByteIntelligenceHubSandbox
        -Dotel.service.instance.id=CentralInstance
        -Dotel.exporter.otlp.protocol=http/protobuf
        -Dotel.metrics.exporter=otlp
        -Dotel.logs.exporter=otlp
        -Dotel.metrics.exporter.interval=10000
        -Dotel.traces.sampler=always_off
        -Dotel.instrumentation.enabled=false
        -Dotel.instrumentation.runtime-metrics.enabled=true
        -Dotel.instrumentation.logback-appender.enabled=false
        -Dotel.instrumentation.log4j-appender.enabled=false
        -Dotel.instrumentation.jul-appender.enabled=false
        -Dotel.instrumentation.log4j-context-data.enabled=false
        -Dotel.javaagent.extensions=com.highbyte.intelligencehub.runtime.otel
        -Dotel.javaagent.logging=application
      PUBLIC_hostname: highbyteCentralNode
      HIGHBYTE_STORE_PASSWORD: password
      #HIGHBYTE_DEPLOYMENT_FILE: /usr/local/highbyte/deployments/deployment-settings.json
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 45245 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # JVM startup takes time

  highbyteRemoteNode1:
    image: highbyte:${IMAGE_VERSION}
#    container_name: highbyteRemoteNode1
    hostname: highbyteRemoteNode1
    ports:
      - 45510:45245
      - 45511:8885
      - 45512:1885
      - 45513:9001
    volumes:
      - highbyteRemoteNode1Vol:/usr/local/highbyte/appData
      - ./remote-node-deployment-settings.json:/usr/local/highbyte/deployments/deployment-settings.json:ro
      - ./remote-node-deployment-config.json:/usr/local/highbyte/deployments/default-deployment-config.json:ro
    networks:
      - pgnet
      - otelnet
      - mqttnet
    environment:
      OTEL_RESOURCE_ATTRIBUTES: service.instance.id=RemoteNode
      JDK_JAVA_OPTIONS: >-
        -javaagent:lib/opentelemetry-javaagent.jar
        -Dotel.exporter.otlp.endpoint=http://lgtm:4318
        -Dotel.service.name=HighByteIntelligenceHubSandbox
        -Dotel.exporter.otlp.protocol=http/protobuf
        -Dotel.metrics.exporter=otlp
        -Dotel.logs.exporter=otlp
        -Dotel.metrics.exporter.interval=10000
        -Dotel.traces.sampler=always_off
        -Dotel.instrumentation.enabled=false
        -Dotel.instrumentation.runtime-metrics.enabled=true
        -Dotel.instrumentation.logback-appender.enabled=false
        -Dotel.instrumentation.log4j-appender.enabled=false
        -Dotel.instrumentation.jul-appender.enabled=false
        -Dotel.instrumentation.log4j-context-data.enabled=false
        -Dotel.javaagent.extensions=com.highbyte.intelligencehub.runtime.otel
        -Dotel.javaagent.logging=application
      PUBLIC_hostname: highbyteRemoteNode1
      HIGHBYTE_STORE_PASSWORD: password
      #HIGHBYTE_DEPLOYMENT_FILE: /usr/local/highbyte/deployments/deployment-settings.json
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 45245 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # JVM startup takes time

  highbyteMqtt:
    image: highbyte:${IMAGE_VERSION}
    #container_name: highbyteMqtt
    hostname: highbyteMqtt
    ports:
      - 45590:45245
      - 45592:1885
    networks:
      - mqttnet
      - otelnet
    environment:
      OTEL_RESOURCE_ATTRIBUTES: service.instance.id=highbyteMqtt
      JDK_JAVA_OPTIONS: >-
        -javaagent:lib/opentelemetry-javaagent.jar
        -Dotel.exporter.otlp.endpoint=http://lgtm:4318
        -Dotel.service.name=HighByteIntelligenceHubSandbox
        -Dotel.exporter.otlp.protocol=http/protobuf
        -Dotel.metrics.exporter=otlp
        -Dotel.logs.exporter=otlp
        -Dotel.metrics.exporter.interval=10000
        -Dotel.traces.sampler=always_off
        -Dotel.instrumentation.enabled=false
        -Dotel.instrumentation.runtime-metrics.enabled=true
        -Dotel.instrumentation.logback-appender.enabled=false
        -Dotel.instrumentation.log4j-appender.enabled=false
        -Dotel.instrumentation.jul-appender.enabled=false
        -Dotel.instrumentation.log4j-context-data.enabled=false
        -Dotel.javaagent.extensions=com.highbyte.intelligencehub.runtime.otel
        -Dotel.javaagent.logging=application
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 45245 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # JVM startup takes time

volumes:
  postgresVol:
  highbyteCentralNodeVol:
  highbyteRemoteNode1Vol:
  
networks:
  pgnet:
    name: pgnet
  otelnet:
    name: otelnet
  mqttnet:
    name: mqttnet
